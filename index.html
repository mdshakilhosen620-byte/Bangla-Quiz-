<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Play & Earn</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        :root {
            --primary-color: #6a11cb;
            --secondary-color: #2575fc;
            --background-color: #f4f4f9;
            --surface-color: #ffffff;
            --text-color: #333333;
            --text-muted-color: #6c757d;
            --success-color: #28a745;
            --error-color: #dc3545;
            --white-color: #ffffff;
            --border-color: #e0e0e0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--background-color); color: var(--text-color); overscroll-behavior-y: contain; }
        .container { max-width: 600px; margin: 0 auto; padding: 1rem; padding-bottom: 80px; }
        .hidden { display: none !important; }
        .notice-bar { background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); color: var(--white-color); padding: 0.5rem; overflow: hidden; white-space: nowrap; position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; }
        .notice-bar p { display: inline-block; padding-left: 100%; animation: scroll-notice 20s linear infinite; }
        @keyframes scroll-notice { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        #auth-section { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; }
        .auth-container { width: 100%; max-width: 380px; padding: 2rem; background-color: var(--surface-color); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .auth-tabs { display: flex; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); }
        .auth-tab { flex: 1; text-align: center; padding: 0.8rem; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; }
        .auth-tab.active { color: var(--secondary-color); border-bottom-color: var(--secondary-color); }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-muted-color); }
        .form-group input { width: 100%; padding: 0.8rem; background-color: #fdfdff; border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); font-size: 1rem; }
        .btn { width: 100%; padding: 0.9rem; border: none; border-radius: 8px; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); color: var(--white-color); font-size: 1rem; font-weight: 600; cursor: pointer; transition: opacity 0.3s; }
        .btn:hover { opacity: 0.9; }
        #app-section { padding-top: 50px; }
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .app-header h1 { font-size: 1.5rem; }
        .balance-chip { background-color: var(--surface-color); padding: 0.5rem 1rem; border-radius: 20px; font-weight: 600; border: 1px solid var(--border-color); }
        .card { background-color: var(--surface-color); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .card h2 { margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        .category-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1rem; }
        .category-item { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 120px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 12px; cursor: pointer; text-align: center; color: var(--white-color); font-weight: 600; transition: transform 0.2s; }
        .category-item:hover { transform: translateY(-5px); }
        .category-item.played { background: #aaa; cursor: not-allowed; opacity: 0.7; }
        .category-item.played:hover { transform: none; }
        .wallet-tabs { display: flex; margin-bottom: 1rem; }
        .wallet-tab { flex: 1; text-align: center; padding: 0.8rem; background-color: #e9ecef; cursor: pointer; color: var(--text-muted-color); }
        .wallet-tab:first-child { border-radius: 8px 0 0 8px; }
        .wallet-tab:last-child { border-radius: 0 8px 8px 0; }
        .wallet-tab.active { background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); color: var(--white-color); }
        .info-box { background-color: #e9ecef; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center; font-size: 0.9rem; line-height: 1.5; border: 1px solid var(--border-color); }
        .history-list-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background-color: #f8f9fa; border-radius: 8px; margin-bottom: 0.75rem; border: 1px solid var(--border-color); }
        .history-item-details { display: flex; flex-direction: column; }
        .history-item-details span { font-size: 0.8rem; color: var(--text-muted-color); }
        .history-item-amount { font-weight: 600; font-size: 1.1rem; }
        .history-item-amount.deposit { color: var(--success-color); }
        .history-item-amount.withdrawal { color: var(--error-color); }
        .history-item-status { font-size: 0.8rem; font-weight: 500; padding: 0.2rem 0.5rem; border-radius: 10px; color: var(--white-color); }
        .status-pending { background-color: #ffc107; color: #333; }
        .status-paid, .status-approved { background-color: var(--success-color); }
        .status-rejected { background-color: var(--error-color); }
        .profile-info { line-height: 1.8; }
        .profile-info p { word-break: break-all; }
        .profile-info span { font-weight: 600; color: var(--primary-color); }
        .btn-logout { margin-top: 1.5rem; background: var(--error-color); }
        #quiz-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--background-color); z-index: 2000; display: flex; flex-direction: column; justify-content: center; padding: 1rem; }
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; font-size: 1.2rem; }
        .timer-circle { width: 50px; height: 50px; border-radius: 50%; border: 3px solid var(--secondary-color); display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .question-area { display: flex; align-items: center; justify-content: center; margin-bottom: 2rem; text-align: center; }
        #read-aloud-btn { font-size: 1.8rem; color: var(--secondary-color); margin-left: 15px; cursor: pointer; transition: transform 0.2s; }
        #read-aloud-btn:hover { transform: scale(1.1); }
        .question-text { font-size: 1.5rem; font-weight: 500; margin-bottom: 0; }
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        .option-btn { padding: 1rem; background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); font-size: 1rem; text-align: left; cursor: pointer; transition: background-color 0.3s, border-color 0.3s; }
        .option-btn:hover { background-color: #f1f1f1; }
        .option-btn.correct { background-color: var(--success-color); border-color: var(--success-color); color: var(--white-color); }
        .option-btn.wrong { background-color: var(--error-color); border-color: var(--error-color); color: var(--white-color); }
        #bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background-color: var(--surface-color); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--border-color); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-muted-color); cursor: pointer; font-size: 0.7rem; transition: color 0.3s; }
        .nav-item i { font-size: 1.5rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--secondary-color); }
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); padding: 1rem 1.5rem; border-radius: 8px; color: var(--white-color); z-index: 3000; opacity: 0; transition: opacity 0.5s, bottom 0.5s; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .toast.show { opacity: 1; bottom: 100px; }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--error-color); }

        /* --- STYLES FOR FULL-SCREEN AD MODAL (UPDATED) --- */
        #ad-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--surface-color);
            z-index: 4000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .ad-modal-content {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        #close-ad-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 35px;
            height: 35px;
            background-color: var(--error-color);
            color: var(--white-color);
            border: none;
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: opacity 0.3s, cursor 0.3s;
            z-index: 4002;
        }
        #close-ad-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #6c757d;
        }
        .ad-container {
            width: 100%;
            height: 100%;
        }
        #ad-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        #ad-timer-display {
            position: absolute;
            top: 15px;
            left: 15px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.2rem;
            z-index: 4002;
        }
        /* --- END OF AD MODAL STYLES --- */
    </style>
</head>
<body>

    <div class="notice-bar">
        <p id="notice-text">Welcome to Play & Earn! Loading latest notices...</p>
    </div>

    <div id="auth-section" class="container">
        <div class="auth-container">
            <div class="auth-tabs">
                <div class="auth-tab active" data-tab="login">Login</div>
                <div class="auth-tab" data-tab="register">Register</div>
            </div>

            <form id="login-form">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="btn">Login</button>
            </form>

            <form id="register-form" class="hidden">
                 <div class="form-group">
                    <label for="register-name">Full Name</label>
                    <input type="text" id="register-name" required>
                </div>
                 <div class="form-group">
                    <label for="register-phone">Phone Number</label>
                    <input type="tel" id="register-phone" required>
                </div>
                <div class="form-group">
                    <label for="register-email">Email</label>
                    <input type="email" id="register-email" required>
                </div>
                <div class="form-group">
                    <label for="register-password">Password</label>
                    <input type="password" id="register-password" required>
                </div>
                <div class="form-group">
                    <label for="register-referral">Referral ID (Optional)</label>
                    <input type="text" id="register-referral">
                </div>
                <button type="submit" class="btn">Register</button>
            </form>
        </div>
    </div>

    <div id="app-section" class="container hidden">
        <header class="app-header">
            <h1>Dashboard</h1>
            <div class="balance-chip">Balance: ৳<span id="user-balance">0</span></div>
        </header>

        <main id="main-content">
            <div id="home-view" class="view">
                <div class="card">
                    <h2>Quiz Categories</h2>
                    <div id="category-grid" class="category-grid">
                        <p>Loading categories...</p>
                    </div>
                </div>
            </div>

            <div id="wallet-view" class="view hidden">
                <div class="wallet-tabs">
                    <div class="wallet-tab active" data-tab="deposit-form-container">Deposit</div>
                    <div class="wallet-tab" data-tab="withdraw-form-container">Withdraw</div>
                </div>

                <div id="deposit-form-container" class="wallet-form-container">
                    <div class="card">
                        <h2>Make a Deposit</h2>
                        <div class="info-box">
                            Bkash Payment to the number below and submit the form.<br>
                            <strong>Number: <span id="deposit-number">Loading...</span></strong>
                        </div>
                        <form id="deposit-form">
                             <div class="form-group">
                                <label for="deposit-amount">Amount</label>
                                <input type="number" id="deposit-amount" required>
                            </div>
                             <div class="form-group">
                                <label for="user-number">Your Number</label>
                                <input type="tel" id="user-number" placeholder="Number you sent from" required>
                            </div>
                             <div class="form-group">
                                <label for="transaction-id">Transaction ID</label>
                                <input type="text" id="transaction-id" required>
                            </div>
                            <button type="submit" class="btn">Submit Deposit</button>
                        </form>
                    </div>
                </div>

                <div id="withdraw-form-container" class="wallet-form-container hidden">
                     <div class="card">
                        <h2>Request a Withdrawal</h2>
                        <div class="info-box">
                            Minimum withdrawal is ৳<span id="min-withdrawal">...</span>. Requests are processed within 24 hours.
                        </div>
                        <form id="withdraw-form">
                             <div class="form-group">
                                <label for="withdraw-amount">Amount</label>
                                <input type="number" id="withdraw-amount" required>
                            </div>
                             <div class="form-group">
                                <label for="withdraw-user-number">Your Bkash/Nagad Number</label>
                                <input type="tel" id="withdraw-user-number" required>
                            </div>
                            <button type="submit" class="btn">Request Withdrawal</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="history-view" class="view hidden">
                <div class="card">
                    <h2>Transaction History</h2>
                    <div id="history-list">
                        <p>Loading your transaction history...</p>
                    </div>
                </div>
            </div>

            <div id="profile-view" class="view hidden">
                 <div class="card">
                    <h2>My Profile</h2>
                    <div class="profile-info">
                        <p>Name: <span id="profile-name"></span></p>
                        <p>Email: <span id="profile-email"></span></p>
                        <p>Phone: <span id="profile-phone"></span></p>
                        <p>My Referral ID: <span id="profile-referral-id"></span></p>
                        <p>Total Referral Bonus: ৳<span id="profile-referral-bonus">0</span></p>
                        <p>Total Referrals: <span id="profile-referral-count">0</span></p>
                    </div>
                    <button id="logout-btn" class="btn btn-logout">Logout</button>
                </div>
            </div>
        </main>

        <nav id="bottom-nav">
            <div class="nav-item active" data-view="home-view">
                <i class='bx bxs-home'></i>
                <span>Home</span>
            </div>
            <div class="nav-item" data-view="wallet-view">
                <i class='bx bxs-wallet'></i>
                <span>Wallet</span>
            </div>
            <div class="nav-item" data-view="history-view">
                <i class='bx bx-history'></i>
                <span>History</span>
            </div>
            <div class="nav-item" data-view="profile-view">
                <i class='bx bxs-user'></i>
                <span>Profile</span>
            </div>
        </nav>
    </div>

    <div id="quiz-view" class="hidden">
        <div class="quiz-container">
            <div class="quiz-header">
                <span id="question-counter">Question 1/10</span>
                <div class="timer-circle" id="timer">20</div>
            </div>
            <div class="question-area">
                <p class="question-text" id="question-text">What is the capital of France?</p>
                <i class='bx bxs-volume-full' id="read-aloud-btn" title="প্রশ্নটি শুনুন"></i>
            </div>
            <div class="options-grid" id="options-grid">
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <!-- --- AD MODAL (UPDATED with iframe) --- -->
    <div id="ad-modal" class="hidden">
        <div class="ad-modal-content">
            <div id="ad-timer-display">20</div>
            <button id="close-ad-btn">&times;</button>
            <div class="ad-container">
                <iframe id="ad-iframe" src="about:blank"></iframe>
            </div>
        </div>
    </div>
    <!-- --- END OF AD MODAL --- -->

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <script>
        // --- PASTE YOUR FIREBASE CONFIGURATION HERE ---
        const firebaseConfig = {
          apiKey: "AIzaSyDc0VE6IAgP_S7mRoLaSsbfRj-rIr9itCQ",
          authDomain: "bangla-quiz-f63e8.firebaseapp.com",
          projectId: "bangla-quiz-f63e8",
          storageBucket: "bangla-quiz-f63e8.firebasestorage.app",
          messagingSenderId: "144677049709",
          appId: "1:144677049709:web:d2d7b8ce63e8968dbd3664"
        };
        // --- END OF FIREBASE CONFIGURATION ---

        // --- আপনার বিজ্ঞাপনের লিংক এখানে পরিবর্তন করুন ---
        const adUrl = "https://accountantflowerrespiration.com/j8p1gm31?key=73807e8f07abd253fec72312b196d630"; // উদাহরণ হিসেবে গুগল ব্যবহার করা হয়েছে।
        // ---------------------------------------------

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let appSettings = {};
        let currentQuizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let timerInterval;
        let adTimerInterval;

        const authSection = document.getElementById('auth-section');
        const appSection = document.getElementById('app-section');
        const mainContent = document.getElementById('main-content');
        const views = document.querySelectorAll('.view');
        const bottomNav = document.getElementById('bottom-nav');

        const showToast = (message, type = 'success') => {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => { toast.className = 'toast'; }, 3000);
        };

        const showView = (viewId) => {
            views.forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId)?.classList.remove('hidden');
            document.querySelector('.nav-item.active')?.classList.remove('active');
            document.querySelector(`.nav-item[data-view="${viewId}"]`)?.classList.add('active');
            const headerTitle = document.querySelector('#app-section h1');
            if (headerTitle) {
                const titleMap = { 'home-view': 'Dashboard', 'wallet-view': 'My Wallet', 'history-view': 'Transaction History', 'profile-view': 'My Profile' };
                headerTitle.textContent = titleMap[viewId] || 'Quiz App';
            }
        };

        auth.onAuthStateChanged(user => {
            if (user) {
                fetchUserData(user.uid);
            } else {
                authSection.classList.remove('hidden');
                appSection.classList.add('hidden');
                currentUser = null;
            }
        });

        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                document.querySelector('.auth-tab.active').classList.remove('active');
                e.target.classList.add('active');
                const targetForm = e.target.dataset.tab;
                document.getElementById('login-form').classList.toggle('hidden', targetForm !== 'login');
                document.getElementById('register-form').classList.toggle('hidden', targetForm !== 'register');
            });
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const phone = document.getElementById('register-phone').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const referrerId = document.getElementById('register-referral').value.trim();
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                const newReferralId = user.uid.substring(0, 6).toUpperCase();

                const userData = {
                    uid: user.uid,
                    name,
                    email,
                    phoneNumber: phone,
                    balance: 20, // Adding 20 Taka welcome bonus
                    playedCategories: [],
                    referralId: newReferralId,
                    referredBy: referrerId || null,
                    referralBonus: 0,
                    totalReferralBonus: 0,
                    referralCount: 0,
                    hasDeposited: false,
                    bonusCredited: true, // Marking welcome bonus as credited
                    welcomeBonus: 20, // Storing the welcome bonus amount
                    transactions: [{
                        type: 'credit',
                        amount: 20,
                        description: 'Welcome Bonus',
                        timestamp: new Date().toISOString(),
                        status: 'completed'
                    }]
                };

                await db.collection('users').doc(user.uid).set(userData);
                showToast('Registration successful!', 'success');
            } catch (error) {
                showToast(error.message, 'error');
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showToast('Login successful!', 'success');
            } catch (error) {
                showToast(error.message, 'error');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
             if ('speechSynthesis' in window) { speechSynthesis.cancel(); }
            auth.signOut();
        });

        const fetchUserData = (uid) => {
            db.collection('users').doc(uid).onSnapshot(doc => {
                if (doc.exists) {
                    currentUser = { uid, ...doc.data() };
                    updateUIWithUserData();
                    authSection.classList.add('hidden');
                    appSection.classList.remove('hidden');
                    fetchAppSettings();
                    loadQuizCategories();
                    loadUserHistory();
                }
            }, err => {
                console.error("Error fetching user data:", err);
                showToast('Could not load user data.', 'error');
            });
        };

        const fetchAppSettings = () => {
            db.collection('settings').doc('appConfig').onSnapshot(doc => {
                if (doc.exists) {
                    appSettings = doc.data();
                    updateUIWithAppSettings();
                }
            }, err => {
                console.error("Error fetching app settings:", err);
            });
        };

        const loadQuizCategories = async () => {
            const grid = document.getElementById('category-grid');
            try {
                const snapshot = await db.collection('questions').get();
                const categories = new Set();
                snapshot.forEach(doc => categories.add(doc.data().categoryId));
                grid.innerHTML = '';
                if (categories.size === 0) {
                    grid.innerHTML = '<p>No quiz categories available right now.</p>';
                    return;
                }
                const played = currentUser.playedCategories || [];
                categories.forEach(cat => {
                    const item = document.createElement('div');
                    item.className = 'category-item';
                    item.textContent = cat;
                    if (played.includes(cat)) {
                        item.classList.add('played');
                        item.title = 'You have already played this quiz';
                    } else {
                        item.onclick = () => startQuiz(cat);
                    }
                    grid.appendChild(item);
                });
            } catch (error) {
                console.error("Error loading categories: ", error);
                grid.innerHTML = '<p>Could not load categories.</p>';
            }
        };
        
        const loadUserHistory = async () => {
            const historyList = document.getElementById('history-list');
            if (!currentUser) return;
            try {
                const depositsPromise = db.collection('deposits').where('userId', '==', currentUser.uid).get();
                const withdrawalsPromise = db.collection('withdrawals').where('userId', '==', currentUser.uid).get();
                const [depositsSnapshot, withdrawalsSnapshot] = await Promise.all([depositsPromise, withdrawalsPromise]);
                let transactions = [];
                depositsSnapshot.forEach(doc => transactions.push({ ...doc.data(), type: 'deposit', id: doc.id }));
                withdrawalsSnapshot.forEach(doc => transactions.push({ ...doc.data(), type: 'withdrawal', id: doc.id }));
                transactions.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
                if (transactions.length === 0) {
                    historyList.innerHTML = '<p>You have no transaction history yet.</p>';
                    return;
                }
                let html = '';
                transactions.forEach(tx => {
                    const date = tx.timestamp.toDate().toLocaleDateString();
                    const statusClass = `status-${tx.status}`;
                    const amountClass = tx.type;
                    const sign = tx.type === 'deposit' ? '+' : '-';
                    html += `<div class="history-list-item"><div class="history-item-details"><strong>${tx.type.charAt(0).toUpperCase() + tx.type.slice(1)} Request</strong><span>${date}</span></div><div><strong class="history-item-amount ${amountClass}">${sign}৳${tx.amount.toFixed(2)}</strong><span class="history-item-status ${statusClass}">${tx.status}</span></div></div>`;
                });
                historyList.innerHTML = html;
            } catch (error) {
                console.error("Error loading transaction history:", error);
                historyList.innerHTML = '<p>Could not load history. Please try again.</p>';
            }
        };

        const updateUIWithUserData = () => {
            if (!currentUser) return;
            document.getElementById('user-balance').textContent = currentUser.balance.toFixed(2);
            document.getElementById('profile-name').textContent = currentUser.name;
            document.getElementById('profile-email').textContent = currentUser.email;
            document.getElementById('profile-phone').textContent = currentUser.phoneNumber;
            document.getElementById('profile-referral-id').textContent = currentUser.referralId || 'N/A';
            document.getElementById('profile-referral-bonus').textContent = (currentUser.totalReferralBonus || 0).toFixed(2);
            document.getElementById('profile-referral-count').textContent = currentUser.referralCount || 0; 
        };
        
        const updateUIWithAppSettings = () => {
            if (!appSettings) return;
            document.getElementById('notice-text').textContent = appSettings.noticeText || 'Welcome!';
            document.getElementById('deposit-number').textContent = appSettings.depositNumber || 'Not set';
            document.getElementById('min-withdrawal').textContent = appSettings.minWithdrawal || 'N/A';
        };

        bottomNav.addEventListener('click', (e) => {
            const navItem = e.target.closest('.nav-item');
            if (navItem) {
                if ('speechSynthesis' in window) { speechSynthesis.cancel(); }
                showView(navItem.dataset.view);
            }
        });

        document.querySelectorAll('.wallet-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                document.querySelector('.wallet-tab.active').classList.remove('active');
                e.target.classList.add('active');
                const targetContainer = e.target.dataset.tab;
                document.querySelectorAll('.wallet-form-container').forEach(c => c.classList.add('hidden'));
                document.getElementById(targetContainer).classList.remove('hidden');
            });
        });

        document.getElementById('deposit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('deposit-amount').value);
            const userNumber = document.getElementById('user-number').value;
            const transactionId = document.getElementById('transaction-id').value;
            if (isNaN(amount) || amount <= 0) return showToast('Please enter a valid amount.', 'error');
            try {
                await db.collection('deposits').add({ 
                    userId: currentUser.uid, 
                    amount, 
                    userNumber, 
                    transactionId, 
                    status: 'pending', 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                });
                showToast('Deposit request submitted! Once approved, your referrer (if any) will receive a bonus.', 'success');
                e.target.reset();
            } catch (error) {
                showToast('Could not submit request. Try again.', 'error');
            }
        });

        document.getElementById('withdraw-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const userNumber = document.getElementById('withdraw-user-number').value;
            if (isNaN(amount) || amount < appSettings.minWithdrawal) return showToast(`Minimum withdrawal is ৳${appSettings.minWithdrawal}.`, 'error');
            if (amount > currentUser.balance) return showToast('Insufficient balance.', 'error');
            try {
                const userRef = db.collection('users').doc(currentUser.uid);
                await db.runTransaction(async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists) throw "User does not exist!";
                    const newBalance = userDoc.data().balance - amount;
                    if (newBalance < 0) throw "Insufficient balance!";
                    transaction.update(userRef, { balance: newBalance });
                    const withdrawalRef = db.collection('withdrawals').doc();
                    transaction.set(withdrawalRef, { userId: currentUser.uid, amount, userNumber, status: 'pending', timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                });
                showToast('Withdrawal request submitted!', 'success');
                e.target.reset();
            } catch (error) {
                showToast(error.message || 'Could not submit request.', 'error');
            }
        });
        
        // --- QUIZ LOGIC ---
        const startQuiz = async (category) => {
            if (currentUser.playedCategories && currentUser.playedCategories.includes(category)) {
                showToast('You have already played this quiz.', 'error');
                return;
            }

            if (currentUser.balance <= 0) {
                showToast('আপনার অ্যাকাউন্টে পর্যাপ্ত ব্যালেন্স নেই। কুইজ খেলতে অনুগ্রহ করে ডিপোজিট করুন।', 'error');
                return;
            }

            try {
                const snapshot = await db.collection('questions').where('categoryId', '==', category).get();
                if (snapshot.empty) {
                    showToast('No questions available in this category.', 'error');
                    return;
                }
                const userRef = db.collection('users').doc(currentUser.uid);
                await userRef.update({ playedCategories: firebase.firestore.FieldValue.arrayUnion(category) });
                currentQuizQuestions = snapshot.docs.map(doc => doc.data());
                currentQuestionIndex = 0;
                score = 0;
                document.getElementById('quiz-view').classList.remove('hidden');
                displayQuestion();
            } catch (error) {
                showToast('Failed to load quiz.', 'error');
                console.error(error);
            }
        };

        const displayQuestion = () => {
            if (currentQuestionIndex >= currentQuizQuestions.length) {
                endQuiz();
                return;
            }
            if ('speechSynthesis' in window) { speechSynthesis.cancel(); }
            const question = currentQuizQuestions[currentQuestionIndex];
            document.getElementById('question-counter').textContent = `Question ${currentQuestionIndex + 1}/${currentQuizQuestions.length}`;
            document.getElementById('question-text').textContent = question.questionText;
            const optionsGrid = document.getElementById('options-grid');
            optionsGrid.innerHTML = '';
            question.options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = option;
                button.onclick = () => selectAnswer(button, option, question.correctAnswer);
                optionsGrid.appendChild(button);
            });

            document.getElementById('read-aloud-btn').onclick = () => {
                if (!('speechSynthesis' in window)) return showToast('Sorry, your browser does not support this feature.', 'error');
                if (speechSynthesis.speaking) { speechSynthesis.cancel(); return; }
                const textToSpeak = `${question.questionText}. অপশন গুলো হলো: ${question.options.join(', ')}.`;
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                let voices = speechSynthesis.getVoices();
                let bengaliVoice = voices.find(voice => voice.lang === 'bn-BD' || voice.lang === 'bn-IN');
                if (bengaliVoice) {
                    utterance.voice = bengaliVoice;
                } else {
                    showToast('আপনার ডিভাইসে বাংলা ভয়েস পাওয়া যায়নি।', 'error');
                }
                utterance.lang = 'bn-BD';
                utterance.rate = 0.9;
                speechSynthesis.speak(utterance);
            };

            startTimer();
        };

        const startTimer = () => {
            clearInterval(timerInterval);
            let timeLeft = appSettings.quizTimer || 20;
            const timerEl = document.getElementById('timer');
            timerEl.textContent = timeLeft;
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleAnswer(false);
                }
            }, 1000);
        };
        
        const selectAnswer = (buttonEl, selectedAnswer, correctAnswer) => {
            clearInterval(timerInterval);
            if ('speechSynthesis' in window) { speechSynthesis.cancel(); }
            const isCorrect = selectedAnswer === correctAnswer;
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === correctAnswer) btn.classList.add('correct');
            });
            if (!isCorrect) buttonEl.classList.add('wrong');
            handleAnswer(isCorrect);
        };

        const handleAnswer = async (isCorrect) => {
            const winAmount = appSettings.quizWinAmount || 5;
            const losePenalty = appSettings.quizLosePenalty || 2;
            const amountChange = isCorrect ? winAmount : -losePenalty;
            try {
                const userRef = db.collection('users').doc(currentUser.uid);
                await userRef.update({ balance: firebase.firestore.FieldValue.increment(amountChange) });
                showToast(isCorrect ? `+৳${winAmount} Correct!` : `-৳${losePenalty} Wrong!`, isCorrect ? 'success' : 'error');
            } catch (error) {
                console.error("Error updating balance:", error);
                showToast('Error updating balance.', 'error');
            }
            currentQuestionIndex++;
            setTimeout(displayQuestion, 1500);
        };

        const startAdTimer = () => {
            clearInterval(adTimerInterval);
            const timerDisplay = document.getElementById('ad-timer-display');
            const closeBtn = document.getElementById('close-ad-btn');
            
            let timeLeft = 20;
            timerDisplay.textContent = timeLeft;
            timerDisplay.classList.remove('hidden');
            closeBtn.disabled = true;
            
            adTimerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(adTimerInterval);
                    timerDisplay.classList.add('hidden');
                    closeBtn.disabled = false;
                }
            }, 1000);
        };

        const endQuiz = () => {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
            // Load the ad URL into the iframe before showing the modal
            document.getElementById('ad-iframe').src = adUrl;
            document.getElementById('quiz-view').classList.add('hidden');
            document.getElementById('ad-modal').classList.remove('hidden');
            startAdTimer();
        };

        document.getElementById('close-ad-btn').addEventListener('click', () => {
            document.getElementById('ad-modal').classList.add('hidden');
            // Clear the iframe src to stop the ad page from running in the background
            document.getElementById('ad-iframe').src = 'about:blank';
            showToast('Quiz finished!', 'success');
            loadQuizCategories();
        });

        showView('home-view');
        if ('speechSynthesis' in window) {
            speechSynthesis.onvoiceschanged = () => { speechSynthesis.getVoices(); };
        }
    </script>

</body>
</html>
